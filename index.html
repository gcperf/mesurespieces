<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>GC Epox-Design – Calcul surface & devis thermolaquage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #050510;
      --bg-card: #151624;
      --border: #272842;
      --accent: #0a8cff;      /* bleu métallisé */
      --accent-2: #00c2ff;
      --text: #f7f7ff;
      --muted: #9b9dc0;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 18px;
      background: radial-gradient(circle at top left,#1b1b3a 0,#050510 48%,#020208 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .shell {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* HEADER */
    .header {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 14px 16px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(0,194,255,0.2), rgba(10,140,255,0.18));
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 18px 40px rgba(0,0,0,0.65);
      backdrop-filter: blur(20px);
    }

    .logo-wrap {
      width: 70px;
      height: 70px;
      flex-shrink: 0;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.14);
      background: radial-gradient(circle at 20% 0, #ffffff22 0, #10111b 40%, #050510 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .logo-wrap img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .brand-main { flex: 1; }

    .brand-title {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }
    .brand-title .highlight { color: var(--accent-2); }

    .brand-sub {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .brand-tags {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      font-size: 0.75rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(1,2,20,0.8);
      color: var(--muted);
    }

    .header-right {
      text-align: right;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .header-right strong { color: var(--accent-2); }

    /* CARDS */
    .card {
      background: radial-gradient(circle at top left,#252747 0,#151624 40%,#090914 100%);
      border-radius: 16px;
      padding: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 14px 32px rgba(0,0,0,0.6);
    }

    .section-title {
      font-size: 0.98rem;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::before {
      content: "";
      width: 6px;
      height: 18px;
      border-radius: 999px;
      background: linear-gradient(180deg,var(--accent-2),var(--accent));
    }

    label {
      font-size: 0.84rem;
      display: block;
      margin-bottom: 3px;
    }

    input, select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #32345b;
      background: rgba(4,5,20,0.95);
      color: var(--text);
      font-size: 0.88rem;
      margin-bottom: 8px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus, select:focus {
      border-color: var(--accent-2);
      box-shadow: 0 0 0 1px rgba(0,194,255,0.4);
      background: #050617;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1;
      min-width: 145px;
    }

    .small {
      font-size: 0.76rem;
      color: var(--muted);
    }

    button {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.87rem;
      font-weight: 600;
      padding: 8px 12px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      background: linear-gradient(135deg,#0a8cff,#0060ff);
      color: #fdfdff;
      box-shadow: 0 6px 16px rgba(0,0,0,0.6);
    }
    button:active { transform: scale(0.97); }

    .btn-secondary {
      background: linear-gradient(135deg,#0c1435,#123a72);
    }
    .btn-danger {
      background: linear-gradient(135deg,#ff4b4b,#c71c1c);
    }

    .btn-full { width: 100%; margin-top: 4px; }

    .result {
      margin-top: 8px;
      padding: 8px;
      border-radius: 11px;
      border: 1px solid rgba(58,60,102,0.95);
      background: radial-gradient(circle at top,#22243f 0,#0a0b17 55%,#060712 100%);
      font-size: 0.9rem;
    }
    .result strong { color: var(--accent-2); }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.83rem;
    }
    th, td {
      border-bottom: 1px solid rgba(46,48,85,0.9);
      padding: 4px 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: radial-gradient(circle at top,#2a2d52 0,#16172a 55%);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .text-right { text-align: right; }

    .totaux {
      margin-top: 6px;
      font-size: 0.9rem;
    }
    .totaux strong { color: var(--accent-2); }

    /* PARAMS ACCORDION */
    .params-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(7,10,30,0.9);
      border: 1px solid rgba(70,90,140,0.9);
      margin-bottom: 8px;
    }
    .params-header span {
      font-size: 0.9rem;
      font-weight: 600;
    }
    .params-header small {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .params-chevron {
      font-size: 1rem;
    }
    .params-body {
      display: none;
      margin-top: 4px;
    }

    .card-soft {
      background: rgba(10,11,25,0.92);
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(68,72,125,0.9);
      margin-bottom: 8px;
    }

    @media (max-width: 700px) {
      body { padding: 12px; }
      .header { flex-direction: row; align-items: flex-start; }
      .header-right { text-align: left; }
    }
  </style>
</head>
<body>
  <div class="shell">

    <!-- HEADER -->
    <header class="header">
      <div class="logo-wrap">
        <img src="logo-gc-epox-design.png" alt="Logo GC Epox-Design" />
      </div>

      <div class="brand-main">
        <div class="brand-title">
          <span>GC</span><span class="highlight">Epox-Design</span>
        </div>
        <div class="brand-sub">
          Calculateur surface & devis – thermolaquage, sablage, limons, garde-corps, pièces soudées.
        </div>
        <div class="brand-tags">
          <span class="tag">Sablage</span>
          <span class="tag">Thermolaquage</span>
          <span class="tag">Acier · Inox · Alu</span>
          <span class="tag">Tarifs atelier</span>
        </div>
      </div>

      <div class="header-right">
        <div><strong>GC Epox-Design</strong></div>
        <div>38 route de la Pépinière<br/>67160 Wissembourg</div>
        <div>Tél. : 07.83.99.27.94</div>
      </div>
    </header>

    <!-- PARAMETRES (ACCORDION) -->
    <section class="card">
      <div class="params-header" id="paramsToggle">
        <div>
          <span>Paramètres & tarifs (thermolaquage + sablage)</span><br />
          <small>Clique pour afficher / masquer</small>
        </div>
        <div class="params-chevron" id="paramsChevron">▼</div>
      </div>

      <div class="params-body" id="paramsBody">
        <!-- GENERAUX -->
        <div class="card-soft">
          <div class="section-title">Paramètres généraux</div>
          <div class="row">
            <div>
              <label>Tarif libre thermolaquage (€/m²)</label>
              <input type="number" id="prixM2Libre" placeholder="ex : 35" />
            </div>
            <div>
              <label>Tarif libre thermolaquage (€/ml)</label>
              <input type="number" id="prixMLLibre" placeholder="ex : 15" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Conso poudre (kg/m²)</label>
              <input type="number" id="poudreM2" placeholder="ex : 0.12" />
            </div>
          </div>
        </div>

        <!-- THERMOLAQUAGE m² / ml -->
        <div class="row">
          <div class="card-soft">
            <div class="section-title">Tôlerie thermolaquage</div>
            <label>Tôle noire – laq 2 f (€/m²)</label>
            <input type="number" id="tarif_tole_noire_laq2_m2" value="50" />
            <label>Tôle noire – laq 2 f (€/ml)</label>
            <input type="number" id="tarif_tole_noire_laq2_ml" value="50" />

            <label>Tôle EZ – laq 1 f (€/m²)</label>
            <input type="number" id="tarif_tole_ez_laq1_m2" value="25" />
            <label>Tôle EZ – laq 1 f (€/ml)</label>
            <input type="number" id="tarif_tole_ez_laq1_ml" value="25" />

            <label>Tôle EZ – laq 2 f (€/m²)</label>
            <input type="number" id="tarif_tole_ez_laq2_m2" value="33" />
            <label>Tôle EZ – laq 2 f (€/ml)</label>
            <input type="number" id="tarif_tole_ez_laq2_ml" value="33" />

            <label>Limon avec plis – laq 2 f (€/m²)</label>
            <input type="number" id="tarif_limon_plis_m2" value="38" />
            <label>Limon avec plis – laq 2 f (€/ml)</label>
            <input type="number" id="tarif_limon_plis_ml" value="38" />

            <label>Tôle alu/galva – laq 1 f (€/m²)</label>
            <input type="number" id="tarif_tole_alu_galva_laq1_m2" value="25" />
            <label>Tôle alu/galva – laq 1 f (€/ml)</label>
            <input type="number" id="tarif_tole_alu_galva_laq1_ml" value="25" />

            <label>Tôle alu/galva – laq 2 f (€/m²)</label>
            <input type="number" id="tarif_tole_alu_galva_laq2_m2" value="32" />
            <label>Tôle alu/galva – laq 2 f (€/ml)</label>
            <input type="number" id="tarif_tole_alu_galva_laq2_ml" value="32" />

            <label>Tôle alu/galva – laq 2 f plis (€/m²)</label>
            <input type="number" id="tarif_tole_alu_galva_plis_m2" value="42" />
            <label>Tôle alu/galva – laq 2 f plis (€/ml)</label>
            <input type="number" id="tarif_tole_alu_galva_plis_ml" value="42" />

            <label>Tôle alu petit format (&lt; 1 m²) – laq 2 f (€/m²)</label>
            <input type="number" id="tarif_tole_alu_petit_m2" value="40" />
            <label>Tôle alu petit format – laq 2 f (€/ml)</label>
            <input type="number" id="tarif_tole_alu_petit_ml" value="40" />

            <label>Inox / fonte – laq 1 f (€/m²)</label>
            <input type="number" id="tarif_inox_laq1_m2" value="35" />
            <label>Inox / fonte – laq 1 f (€/ml)</label>
            <input type="number" id="tarif_inox_laq1_ml" value="35" />

            <label>Inox / fonte – laq 2 f (€/m²)</label>
            <input type="number" id="tarif_inox_laq2_m2" value="47" />
            <label>Inox / fonte – laq 2 f (€/ml)</label>
            <input type="number" id="tarif_inox_laq2_ml" value="47" />

            <label>Tôle perforée acier – laq 2 f (€/m²)</label>
            <input type="number" id="tarif_tole_perforee_m2" value="50" />
            <label>Tôle perforée acier – laq 2 f (€/ml)</label>
            <input type="number" id="tarif_tole_perforee_ml" value="50" />
          </div>

          <div class="card-soft">
            <div class="section-title">Gardes-corps thermolaquage</div>

            <label>GC barreautés – neuf (€/m²)</label>
            <input type="number" id="tarif_gc_barreautes_neuf_m2" value="39" />
            <label>GC barreautés – neuf (€/ml)</label>
            <input type="number" id="tarif_gc_barreautes_neuf_ml" value="39" />

            <label>GC barreautés – réno (€/m²)</label>
            <input type="number" id="tarif_gc_barreautes_reno_m2" value="48.5" />
            <label>GC barreautés – réno (€/ml)</label>
            <input type="number" id="tarif_gc_barreautes_reno_ml" value="48.5" />

            <label>GC tôles – neuf (€/m²)</label>
            <input type="number" id="tarif_gc_toles_neuf_m2" value="47" />
            <label>GC tôles – neuf (€/ml)</label>
            <input type="number" id="tarif_gc_toles_neuf_ml" value="47" />

            <label>GC tôles – réno (€/m²)</label>
            <input type="number" id="tarif_gc_toles_reno_m2" value="51.5" />
            <label>GC tôles – réno (€/ml)</label>
            <input type="number" id="tarif_gc_toles_reno_ml" value="51.5" />

            <label>GC alu galva (€/m²)</label>
            <input type="number" id="tarif_gc_alu_galva_m2" value="34" />
            <label>GC alu galva (€/ml)</label>
            <input type="number" id="tarif_gc_alu_galva_ml" value="34" />

            <label>GC galva / alu forgé (€/m²)</label>
            <input type="number" id="tarif_gc_galva_forge_m2" value="37" />
            <label>GC galva / alu forgé (€/ml)</label>
            <input type="number" id="tarif_gc_galva_forge_ml" value="37" />

            <label>GC forgé – neuf (€/m²)</label>
            <input type="number" id="tarif_gc_forge_neuf_m2" value="79" />
            <label>GC forgé – neuf (€/ml)</label>
            <input type="number" id="tarif_gc_forge_neuf_ml" value="79" />

            <label>GC forgé – réno (€/m²)</label>
            <input type="number" id="tarif_gc_forge_reno_m2" value="95" />
            <label>GC forgé – réno (€/ml)</label>
            <input type="number" id="tarif_gc_forge_reno_ml" value="95" />

            <label>GC mikado (€/m²)</label>
            <input type="number" id="tarif_gc_mikado_m2" value="60" />
            <label>GC mikado (€/ml)</label>
            <input type="number" id="tarif_gc_mikado_ml" value="60" />

            <label>GC barreautage chargé – neuf (€/m²)</label>
            <input type="number" id="tarif_gc_barreautage_neuf_m2" value="47" />
            <label>GC barreautage chargé – neuf (€/ml)</label>
            <input type="number" id="tarif_gc_barreautage_neuf_ml" value="47" />

            <label>GC barreautage chargé – réno (€/m²)</label>
            <input type="number" id="tarif_gc_barreautage_reno_m2" value="55" />
            <label>GC barreautage chargé – réno (€/ml)</label>
            <input type="number" id="tarif_gc_barreautage_reno_ml" value="55" />
          </div>
        </div>

        <!-- SABLAGE SEUL -->
        <div class="card-soft">
          <div class="section-title">Sablage seul</div>
          <div class="row">
            <div>
              <label>Sablage acier – (€/m²)</label>
              <input type="number" id="tarif_sablage_acier_m2" value="15" />
              <label>Sablage acier – (€/ml)</label>
              <input type="number" id="tarif_sablage_acier_ml" value="15" />
            </div>
            <div>
              <label>Sablage alu – (€/m²)</label>
              <input type="number" id="tarif_sablage_alu_m2" value="18" />
              <label>Sablage alu – (€/ml)</label>
              <input type="number" id="tarif_sablage_alu_ml" value="18" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Sablage inox – (€/m²)</label>
              <input type="number" id="tarif_sablage_inox_m2" value="20" />
              <label>Sablage inox – (€/ml)</label>
              <input type="number" id="tarif_sablage_inox_ml" value="20" />
            </div>
            <div>
              <label>Sablage tôle perforée – (€/m²)</label>
              <input type="number" id="tarif_sablage_perfore_m2" value="22" />
              <label>Sablage tôle perforée – (€/ml)</label>
              <input type="number" id="tarif_sablage_perfore_ml" value="22" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Sablage premium grenaille inox – (€/m²)</label>
              <input type="number" id="tarif_sablage_premium_m2" value="28" />
              <label>Sablage premium grenaille inox – (€/ml)</label>
              <input type="number" id="tarif_sablage_premium_ml" value="28" />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CALCUL PIECE : TYPE = GEO + TARIF -->
    <section class="card">
      <div class="section-title">Calcul pièce (type + tarif en un seul choix)</div>

      <div class="row">
        <div>
          <label>Nom / référence pièce</label>
          <input type="text" id="pieceRef" placeholder="ex : GC palier, limon gauche..." />
        </div>
        <div>
          <label>Type de pièce (géométrie + tarif)</label>
          <select id="pieceType">
            <optgroup label="Plaques / tôles (thermolaquage)">
              <option value="plaque_libre">Plaque / tôle – tarif libre</option>
              <option value="plaque_tole_ez_1f">Plaque tôle EZ laq 1 f</option>
              <option value="plaque_tole_ez_2f">Plaque tôle EZ laq 2 f</option>
              <option value="plaque_tole_noire_2f">Plaque tôle noire laq 2 f</option>
              <option value="plaque_alu_galva_1f">Plaque alu/galva laq 1 f</option>
              <option value="plaque_alu_galva_2f">Plaque alu/galva laq 2 f</option>
              <option value="plaque_alu_galva_plis">Plaque alu/galva laq 2 f plis</option>
              <option value="plaque_alu_petit">Plaque alu &lt; 1 m² laq 2 f</option>
              <option value="plaque_inox_1f">Plaque inox/fonte laq 1 f</option>
              <option value="plaque_inox_2f">Plaque inox/fonte laq 2 f</option>
              <option value="plaque_tole_perforee">Plaque tôle perforée laq 2 f</option>
            </optgroup>

            <optgroup label="Tubes / profils (thermolaquage)">
              <option value="tube_rect_libre">Tube rectangulaire – tarif libre</option>
              <option value="tube_rond_libre">Tube rond – tarif libre</option>
              <option value="plat_libre">Plat – tarif libre</option>
              <option value="profilU_libre">Profil U – tarif libre</option>
              <option value="corniereL_libre">Cornière L – tarif libre</option>
              <option value="profil_special_libre">Profil spécial – tarif libre</option>
            </optgroup>

            <optgroup label="Limons / pièces soudées (thermolaquage)">
              <option value="limon_plis_thermo">Limon avec plis – laq 2 f (grille)</option>
              <option value="limon_libre">Limon / pièce soudée – tarif libre</option>
            </optgroup>

            <optgroup label="Garde-corps (thermolaquage)">
              <option value="gc_barreautes_neuf_plaque">GC barreautés neuf (plaque)</option>
              <option value="gc_barreautes_reno_plaque">GC barreautés réno (plaque)</option>
              <option value="gc_toles_neuf_plaque">GC tôles neuf (plaque)</option>
              <option value="gc_toles_reno_plaque">GC tôles réno (plaque)</option>
            </optgroup>

            <optgroup label="Sablage seul (sur plaque/profil)">
              <option value="plaque_sablage_acier">Plaque/profil – sablage acier</option>
              <option value="plaque_sablage_alu">Plaque/profil – sablage alu</option>
              <option value="plaque_sablage_inox">Plaque/profil – sablage inox</option>
              <option value="plaque_sablage_perfore">Plaque/perforée – sablage</option>
              <option value="plaque_sablage_premium">Plaque/profil – sablage premium inox</option>
            </optgroup>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Mode facturation</label>
          <select id="modeFacturation">
            <option value="m2">Au m² (surface)</option>
            <option value="ml">Au ml (longueur)</option>
          </select>
        </div>
        <div>
          <label>Nombre de faces</label>
          <select id="nbFaces">
            <option value="1">1 face</option>
            <option value="2">2 faces</option>
          </select>
        </div>
        <div>
          <label>Quantité de pièces</label>
          <input type="number" id="pieceQuantite" value="1" min="1" />
        </div>
      </div>

      <!-- BLOCS GEOMETRIE -->

      <!-- PLAQUE -->
      <div id="geo-plaque" class="geo-block">
        <div class="row">
          <div>
            <label>Longueur (mm)</label>
            <input type="number" id="plaqueLongueur" />
          </div>
          <div>
            <label>Largeur (mm)</label>
            <input type="number" id="plaqueLargeur" />
          </div>
        </div>
      </div>

      <!-- TUBE RECT -->
      <div id="geo-tubeRect" class="geo-block" style="display:none;">
        <div class="row">
          <div>
            <label>Largeur tube (mm)</label>
            <input type="number" id="tubeRectLargeur" />
          </div>
          <div>
            <label>Hauteur tube (mm)</label>
            <input type="number" id="tubeRectHauteur" />
          </div>
        </div>
        <label>Longueur (mm)</label>
        <input type="number" id="tubeRectLongueur" />
        <p class="small">Formule 1 face : ~2 côtés du tube (½ périmètre × longueur).</p>
      </div>

      <!-- TUBE ROND -->
      <div id="geo-tubeRond" class="geo-block" style="display:none;">
        <label>Diamètre extérieur (mm)</label>
        <input type="number" id="tubeRondDiametre" />
        <label>Longueur (mm)</label>
        <input type="number" id="tubeRondLongueur" />
        <p class="small">Formule 1 face : ~½ circonférence × longueur.</p>
      </div>

      <!-- PLAT -->
      <div id="geo-plat" class="geo-block" style="display:none;">
        <div class="row">
          <div>
            <label>Largeur plat (mm)</label>
            <input type="number" id="platLargeur" />
          </div>
          <div>
            <label>Longueur (mm)</label>
            <input type="number" id="platLongueur" />
          </div>
        </div>
        <p class="small">Formule 1 face : largeur × longueur (champs non comptés).</p>
      </div>

      <!-- PROFIL U -->
      <div id="geo-profilU" class="geo-block" style="display:none;">
        <div class="row">
          <div>
            <label>Largeur semelle (mm)</label>
            <input type="number" id="uSemelle" />
          </div>
          <div>
            <label>Hauteur (mm)</label>
            <input type="number" id="uHauteur" />
          </div>
        </div>
        <label>Longueur (mm)</label>
        <input type="number" id="uLongueur" />
        <p class="small">Formule 1 face : (semelle + 2 × hauteur) × longueur.</p>
      </div>

      <!-- CORNIERE L -->
      <div id="geo-corniereL" class="geo-block" style="display:none;">
        <div class="row">
          <div>
            <label>Aile 1 (mm)</label>
            <input type="number" id="corniereAile1" />
          </div>
          <div>
            <label>Aile 2 (mm)</label>
            <input type="number" id="corniereAile2" />
          </div>
        </div>
        <label>Longueur (mm)</label>
        <input type="number" id="corniereLongueur" />
        <p class="small">Formule 1 face : (aile1 + aile2) × longueur.</p>
      </div>

      <!-- PROFIL SPECIAL -->
      <div id="geo-profilSpecial" class="geo-block" style="display:none;">
        <label>Périmètre développé (mm)</label>
        <input type="number" id="perimLibre" />
        <label>Longueur (mm)</label>
        <input type="number" id="perimLibreLongueur" />
      </div>

      <!-- LIMON -->
      <div id="geo-limon" class="geo-block" style="display:none; margin-top:6px;">
        <div class="section-title">Profil limon + supports</div>
        <label>Type de profil limon</label>
        <select id="limonProfilType">
          <option value="tubeRect">Tube rectangulaire</option>
          <option value="tubeRond">Tube rond</option>
          <option value="plat">Plat</option>
          <option value="profilU">Profil U</option>
          <option value="perimetreLibre">Profil spécial (périmètre connu)</option>
        </select>

        <div id="blocLimon-tubeRect">
          <div class="row">
            <div>
              <label>Largeur tube (mm)</label>
              <input type="number" id="limonTubeRectLargeur" />
            </div>
            <div>
              <label>Hauteur tube (mm)</label>
              <input type="number" id="limonTubeRectHauteur" />
            </div>
          </div>
        </div>

        <div id="blocLimon-tubeRond" style="display:none;">
          <label>Diamètre tube (mm)</label>
          <input type="number" id="limonTubeRondDiametre" />
        </div>

        <div id="blocLimon-plat" style="display:none;">
          <div class="row">
            <div>
              <label>Largeur plat (mm)</label>
              <input type="number" id="limonPlatLargeur" />
            </div>
          </div>
        </div>

        <div id="blocLimon-profilU" style="display:none;">
          <div class="row">
            <div>
              <label>Largeur semelle U (mm)</label>
              <input type="number" id="limonUSemelle" />
            </div>
            <div>
              <label>Hauteur U (mm)</label>
              <input type="number" id="limonUHauteur" />
            </div>
          </div>
        </div>

        <div id="blocLimon-perimetreLibre" style="display:none;">
          <label>Périmètre développé limon (mm)</label>
          <input type="number" id="limonPerimLibre" />
        </div>

        <label>Longueur limon (mm)</label>
        <input type="number" id="limonLongueur" />

        <div style="margin-top:10px;">
          <div class="section-title">Supports de marche (pièces soudées)</div>
          <p class="small">Formule 1 face : (vertical + horizontal) en 1 face chacun.</p>
          <div class="row">
            <div>
              <label>Largeur support (mm)</label>
              <input type="number" id="supportLargeur" />
            </div>
            <div>
              <label>Hauteur verticale (mm)</label>
              <input type="number" id="supportHauteur" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Longueur horizontale (mm)</label>
              <input type="number" id="supportLongueur" />
            </div>
            <div>
              <label>Nombre de supports / marches</label>
              <input type="number" id="supportNb" value="0" />
            </div>
          </div>
        </div>
      </div>

      <button class="btn-full" id="btnCalcPiece">Calculer surface / longueur</button>
      <button class="btn-full" id="btnAddDevis" style="margin-top:6px;">Ajouter au devis</button>

      <div class="result" id="resultPiece">
        Choisis le type de pièce, 1 face / 2 faces, m² ou ml, puis clique sur <strong>Calculer</strong>.
      </div>
    </section>

    <!-- RECAP DEVIS -->
    <section class="card">
      <div class="section-title">Récap devis – GC Epox-Design</div>
      <p class="small">Chaque clic sur “Ajouter au devis” ajoute une ligne ci-dessous.</p>

      <div style="max-height: 260px; overflow:auto; border-radius:12px; border:1px solid rgba(68,72,125,0.9); margin-bottom:6px;">
        <table id="tableDevis">
          <thead>
          <tr>
            <th>#</th>
            <th>Référence</th>
            <th>Type</th>
            <th class="text-right">Qté</th>
            <th class="text-right">Faces</th>
            <th class="text-right">Surf/pièce (m²)</th>
            <th class="text-right">Longueur/pièce (m)</th>
            <th class="text-right">Total m²</th>
            <th class="text-right">Total ml</th>
            <th class="text-right">Prix (€)</th>
            <th class="text-right">Poudre (kg)</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="totaux" id="totauxDevis">
        Aucun élément pour l’instant.
      </div>

      <button class="btn-secondary btn-full btn-danger" id="btnResetDevis" style="margin-top:8px;">Vider le devis</button>
    </section>
  </div>

  <script>
    function parseNumber(v) {
      if (!v && v !== 0) return 0;
      return parseFloat(String(v).replace(",", ".")) || 0;
    }
    function mmToM(mm) { return mm / 1000; }

    // Accordion
    const paramsToggle = document.getElementById("paramsToggle");
    const paramsBody = document.getElementById("paramsBody");
    const paramsChevron = document.getElementById("paramsChevron");
    paramsToggle.addEventListener("click", () => {
      const visible = paramsBody.style.display === "block";
      paramsBody.style.display = visible ? "none" : "block";
      paramsChevron.textContent = visible ? "▼" : "▲";
    });

    // ===== MAPPING TYPE -> GEO + TARIF + FACES + MODE =====
    const PIECE_DEFS = {
      // Plaques – thermo
      plaque_libre:          { label: "Plaque / tôle – tarif libre",       geo: "plaque", tarifKey: "",                 defaultFaces: 1, defaultMode: "m2" },
      plaque_tole_ez_1f:     { label: "Plaque tôle EZ laq 1 f",            geo: "plaque", tarifKey: "tole_ez_laq1",     defaultFaces: 1, defaultMode: "m2" },
      plaque_tole_ez_2f:     { label: "Plaque tôle EZ laq 2 f",            geo: "plaque", tarifKey: "tole_ez_laq2",     defaultFaces: 2, defaultMode: "m2" },
      plaque_tole_noire_2f:  { label: "Plaque tôle noire laq 2 f",         geo: "plaque", tarifKey: "tole_noire_laq2",  defaultFaces: 2, defaultMode: "m2" },
      plaque_alu_galva_1f:   { label: "Plaque alu/galva laq 1 f",          geo: "plaque", tarifKey: "tole_alu_galva_laq1", defaultFaces: 1, defaultMode: "m2" },
      plaque_alu_galva_2f:   { label: "Plaque alu/galva laq 2 f",          geo: "plaque", tarifKey: "tole_alu_galva_laq2", defaultFaces: 2, defaultMode: "m2" },
      plaque_alu_galva_plis: { label: "Plaque alu/galva laq 2 f plis",     geo: "plaque", tarifKey: "tole_alu_galva_plis", defaultFaces: 2, defaultMode: "m2" },
      plaque_alu_petit:      { label: "Plaque alu < 1 m² laq 2 f",         geo: "plaque", tarifKey: "tole_alu_petit",  defaultFaces: 2, defaultMode: "m2" },
      plaque_inox_1f:        { label: "Plaque inox/fonte laq 1 f",         geo: "plaque", tarifKey: "inox_laq1",       defaultFaces: 1, defaultMode: "m2" },
      plaque_inox_2f:        { label: "Plaque inox/fonte laq 2 f",         geo: "plaque", tarifKey: "inox_laq2",       defaultFaces: 2, defaultMode: "m2" },
      plaque_tole_perforee:  { label: "Plaque tôle perforée laq 2 f",      geo: "plaque", tarifKey: "tole_perforee",   defaultFaces: 2, defaultMode: "m2" },

      // Tubes & profils – thermo
      tube_rect_libre:       { label: "Tube rectangulaire – tarif libre",  geo: "tubeRect", tarifKey: "",             defaultFaces: 1, defaultMode: "m2" },
      tube_rond_libre:       { label: "Tube rond – tarif libre",           geo: "tubeRond", tarifKey: "",             defaultFaces: 1, defaultMode: "m2" },
      plat_libre:            { label: "Plat – tarif libre",                geo: "plat",     tarifKey: "",             defaultFaces: 1, defaultMode: "m2" },
      profilU_libre:         { label: "Profil U – tarif libre",            geo: "profilU",  tarifKey: "",             defaultFaces: 1, defaultMode: "m2" },
      corniereL_libre:       { label: "Cornière L – tarif libre",          geo: "corniereL",tarifKey: "",             defaultFaces: 1, defaultMode: "m2" },
      profil_special_libre:  { label: "Profil spécial – tarif libre",      geo: "profilSpecial", tarifKey: "",        defaultFaces: 1, defaultMode: "m2" },

      // Limons – thermo
      limon_plis_thermo:     { label: "Limon avec plis – laq 2 f (grille)", geo: "limon", tarifKey: "limon_plis",     defaultFaces: 2, defaultMode: "m2" },
      limon_libre:           { label: "Limon / pièce soudée – libre",      geo: "limon", tarifKey: "",                defaultFaces: 2, defaultMode: "m2" },

      // GC – on calcule comme une plaque
      gc_barreautes_neuf_plaque: { label: "GC barreautés neuf",            geo: "plaque", tarifKey: "gc_barreautes_neuf", defaultFaces: 2, defaultMode: "m2" },
      gc_barreautes_reno_plaque: { label: "GC barreautés réno",            geo: "plaque", tarifKey: "gc_barreautes_reno", defaultFaces: 2, defaultMode: "m2" },
      gc_toles_neuf_plaque:      { label: "GC tôles neuf",                 geo: "plaque", tarifKey: "gc_toles_neuf",     defaultFaces: 2, defaultMode: "m2" },
      gc_toles_reno_plaque:      { label: "GC tôles réno",                 geo: "plaque", tarifKey: "gc_toles_reno",     defaultFaces: 2, defaultMode: "m2" },

      // Sablage seul (géométrie = plaque par défaut, tu peux mesurer n'importe quoi comme une surface)
      plaque_sablage_acier:   { label: "Sablage acier",   geo: "plaque", tarifKey: "sablage_acier",   defaultFaces: 1, defaultMode: "m2" },
      plaque_sablage_alu:     { label: "Sablage alu",     geo: "plaque", tarifKey: "sablage_alu",     defaultFaces: 1, defaultMode: "m2" },
      plaque_sablage_inox:    { label: "Sablage inox",    geo: "plaque", tarifKey: "sablage_inox",    defaultFaces: 1, defaultMode: "m2" },
      plaque_sablage_perfore: { label: "Sablage tôle perforée", geo: "plaque", tarifKey: "sablage_perfore", defaultFaces: 1, defaultMode: "m2" },
      plaque_sablage_premium: { label: "Sablage premium grenaille inox", geo: "plaque", tarifKey: "sablage_premium", defaultFaces: 1, defaultMode: "m2" },
    };

    // Tarifs mapping
    const TARIF_IDS_M2 = {
      tole_noire_laq2: "tarif_tole_noire_laq2_m2",
      tole_ez_laq1: "tarif_tole_ez_laq1_m2",
      tole_ez_laq2: "tarif_tole_ez_laq2_m2",
      limon_plis: "tarif_limon_plis_m2",
      tole_alu_galva_laq1: "tarif_tole_alu_galva_laq1_m2",
      tole_alu_galva_laq2: "tarif_tole_alu_galva_laq2_m2",
      tole_alu_galva_plis: "tarif_tole_alu_galva_plis_m2",
      tole_alu_petit: "tarif_tole_alu_petit_m2",
      inox_laq1: "tarif_inox_laq1_m2",
      inox_laq2: "tarif_inox_laq2_m2",
      tole_perforee: "tarif_tole_perforee_m2",
      gc_barreautes_neuf: "tarif_gc_barreautes_neuf_m2",
      gc_barreautes_reno: "tarif_gc_barreautes_reno_m2",
      gc_toles_neuf: "tarif_gc_toles_neuf_m2",
      gc_toles_reno: "tarif_gc_toles_reno_m2",
      gc_alu_galva: "tarif_gc_alu_galva_m2",
      gc_galva_forge: "tarif_gc_galva_forge_m2",
      gc_forge_neuf: "tarif_gc_forge_neuf_m2",
      gc_forge_reno: "tarif_gc_forge_reno_m2",
      gc_mikado: "tarif_gc_mikado_m2",
      gc_barreautage_neuf: "tarif_gc_barreautage_neuf_m2",
      gc_barreautage_reno: "tarif_gc_barreautage_reno_m2",
      sablage_acier: "tarif_sablage_acier_m2",
      sablage_alu: "tarif_sablage_alu_m2",
      sablage_inox: "tarif_sablage_inox_m2",
      sablage_perfore: "tarif_sablage_perfore_m2",
      sablage_premium: "tarif_sablage_premium_m2",
    };
    const TARIF_IDS_ML = {
      tole_noire_laq2: "tarif_tole_noire_laq2_ml",
      tole_ez_laq1: "tarif_tole_ez_laq1_ml",
      tole_ez_laq2: "tarif_tole_ez_laq2_ml",
      limon_plis: "tarif_limon_plis_ml",
      tole_alu_galva_laq1: "tarif_tole_alu_galva_laq1_ml",
      tole_alu_galva_laq2: "tarif_tole_alu_galva_laq2_ml",
      tole_alu_galva_plis: "tarif_tole_alu_galva_plis_ml",
      tole_alu_petit: "tarif_tole_alu_petit_ml",
      inox_laq1: "tarif_inox_laq1_ml",
      inox_laq2: "tarif_inox_laq2_ml",
      tole_perforee: "tarif_tole_perforee_ml",
      gc_barreautes_neuf: "tarif_gc_barreautes_neuf_ml",
      gc_barreautes_reno: "tarif_gc_barreautes_reno_ml",
      gc_toles_neuf: "tarif_gc_toles_neuf_ml",
      gc_toles_reno: "tarif_gc_toles_reno_ml",
      gc_alu_galva: "tarif_gc_alu_galva_ml",
      gc_galva_forge: "tarif_gc_galva_forge_ml",
      gc_forge_neuf: "tarif_gc_forge_neuf_ml",
      gc_forge_reno: "tarif_gc_forge_reno_ml",
      gc_mikado: "tarif_gc_mikado_ml",
      gc_barreautage_neuf: "tarif_gc_barreautage_neuf_ml",
      gc_barreautage_reno: "tarif_gc_barreautage_reno_ml",
      sablage_acier: "tarif_sablage_acier_ml",
      sablage_alu: "tarif_sablage_alu_ml",
      sablage_inox: "tarif_sablage_inox_ml",
      sablage_perfore: "tarif_sablage_perfore_ml",
      sablage_premium: "tarif_sablage_premium_ml",
    };

    function getTarifM2(key) {
      if (!key) return parseNumber(document.getElementById("prixM2Libre").value);
      const id = TARIF_IDS_M2[key];
      if (!id) return 0;
      return parseNumber(document.getElementById(id).value);
    }
    function getTarifML(key) {
      if (!key) return parseNumber(document.getElementById("prixMLLibre").value);
      const id = TARIF_IDS_ML[key];
      if (!id) return 0;
      return parseNumber(document.getElementById(id).value);
    }

    // Show correct geo block on type change
    const pieceTypeSelect = document.getElementById("pieceType");
    const geoBlocks = {
      plaque: document.getElementById("geo-plaque"),
      tubeRect: document.getElementById("geo-tubeRect"),
      tubeRond: document.getElementById("geo-tubeRond"),
      plat: document.getElementById("geo-plat"),
      profilU: document.getElementById("geo-profilU"),
      corniereL: document.getElementById("geo-corniereL"),
      profilSpecial: document.getElementById("geo-profilSpecial"),
      limon: document.getElementById("geo-limon"),
    };
    const modeFacturationSelect = document.getElementById("modeFacturation");
    const nbFacesSelect = document.getElementById("nbFaces");

    function applyPieceDef() {
      const key = pieceTypeSelect.value;
      const def = PIECE_DEFS[key];
      Object.values(geoBlocks).forEach(b => { if (b) b.style.display = "none"; });
      if (def && geoBlocks[def.geo]) geoBlocks[def.geo].style.display = "block";

      if (def) {
        modeFacturationSelect.value = def.defaultMode;
        nbFacesSelect.value = String(def.defaultFaces);
      }
    }
    pieceTypeSelect.addEventListener("change", applyPieceDef);
    applyPieceDef();

    // Limon profil blocks
    const limonProfilType = document.getElementById("limonProfilType");
    const limonBlocks = {
      tubeRect: document.getElementById("blocLimon-tubeRect"),
      tubeRond: document.getElementById("blocLimon-tubeRond"),
      plat: document.getElementById("blocLimon-plat"),
      profilU: document.getElementById("blocLimon-profilU"),
      perimetreLibre: document.getElementById("blocLimon-perimetreLibre"),
    };
    function showLimonProfilBlock() {
      const t = limonProfilType.value;
      Object.keys(limonBlocks).forEach(k => limonBlocks[k].style.display = "none");
      if (limonBlocks[t]) limonBlocks[t].style.display = "block";
    }
    limonProfilType.addEventListener("change", showLimonProfilBlock);
    showLimonProfilBlock();

    const resultPiece = document.getElementById("resultPiece");

    function calcPiece() {
      const key = pieceTypeSelect.value;
      const def = PIECE_DEFS[key];
      if (!def) {
        resultPiece.innerHTML = "⚠️ Choisis un type de pièce.";
        return null;
      }
      const geoType = def.geo;
      const qte = parseNumber(document.getElementById("pieceQuantite").value) || 1;
      const ref = document.getElementById("pieceRef").value.trim();
      const modeFacturation = modeFacturationSelect.value;
      const nbFaces = parseInt(nbFacesSelect.value, 10) || def.defaultFaces;
      const tarifKey = def.tarifKey;
      const tarifLabel = def.label;

      let surf1FaceParPiece_m2 = 0;
      let surfParPiece_m2 = 0;
      let longueurParPiece_m = 0;
      let details = "";

      // Formules 1 face
      if (geoType === "plaque") {
        const L = mmToM(parseNumber(document.getElementById("plaqueLongueur").value));
        const l = mmToM(parseNumber(document.getElementById("plaqueLargeur").value));
        surf1FaceParPiece_m2 = L * l;
        surfParPiece_m2 = surf1FaceParPiece_m2 * nbFaces;
        longueurParPiece_m = L;
        details = `Plaque – L=${L.toFixed(3)} m, l=${l.toFixed(3)} m.`;
      }

      if (geoType === "tubeRect") {
        const larg = mmToM(parseNumber(document.getElementById("tubeRectLargeur").value));
        const haut = mmToM(parseNumber(document.getElementById("tubeRectHauteur").value));
        const long = mmToM(parseNumber(document.getElementById("tubeRectLongueur").value));
        const perim = 2 * (larg + haut);

        // 1 face ~ 2 côtés du tube
        surf1FaceParPiece_m2 = (perim / 2) * long;
        surfParPiece_m2 = surf1FaceParPiece_m2 * nbFaces;
        longueurParPiece_m = long;
        details = `Tube rect ${larg.toFixed(3)}×${haut.toFixed(3)} m, L=${long.toFixed(3)} m.`;
      }

      if (geoType === "tubeRond") {
        const d = mmToM(parseNumber(document.getElementById("tubeRondDiametre").value));
        const L = mmToM(parseNumber(document.getElementById("tubeRondLongueur").value));

        // 1 face ~ 1/2 circonférence
        surf1FaceParPiece_m2 = (Math.PI * d * L) / 2;
        surfParPiece_m2 = surf1FaceParPiece_m2 * nbFaces;
        longueurParPiece_m = L;
        details = `Tube rond D=${d.toFixed(3)} m, L=${L.toFixed(3)} m.`;
      }

      if (geoType === "corniereL") {
        const a1 = mmToM(parseNumber(document.getElementById("corniereAile1").value));
        const a2 = mmToM(parseNumber(document.getElementById("corniereAile2").value));
        const L = mmToM(parseNumber(document.getElementById("corniereLongueur").value));
        const dev1Face = a1 + a2;
        surf1FaceParPiece_m2 = dev1Face * L;
        surfParPiece_m2 = surf1FaceParPiece_m2 * nbFaces;
        longueurParPiece_m = L;
        details = `Cornière L – ailes ${a1.toFixed(3)} / ${a2.toFixed(3)} m, L=${L.toFixed(3)} m.`;
      }

      if (geoType === "profilU") {
        const sem = mmToM(parseNumber(document.getElementById("uSemelle").value));
        const h = mmToM(parseNumber(document.getElementById("uHauteur").value));
        const L = mmToM(parseNumber(document.getElementById("uLongueur").value));
        const dev1Face = sem + 2 * h;
        surf1FaceParPiece_m2 = dev1Face * L;
        surfParPiece_m2 = surf1FaceParPiece_m2 * nbFaces;
        longueurParPiece_m = L;
        details = `Profil U – sem=${sem.toFixed(3)} m, h=${h.toFixed(3)} m, L=${L.toFixed(3)} m.`;
      }

      if (geoType === "plat") {
        const larg = mmToM(parseNumber(document.getElementById("platLargeur").value));
        const L = mmToM(parseNumber(document.getElementById("platLongueur").value));
        surf1FaceParPiece_m2 = larg * L;
        surfParPiece_m2 = surf1FaceParPiece_m2 * nbFaces;
        longueurParPiece_m = L;
        details = `Plat – larg=${larg.toFixed(3)} m, L=${L.toFixed(3)} m.`;
      }

      if (geoType === "profilSpecial") {
        const perim = mmToM(parseNumber(document.getElementById("perimLibre").value));
        const L = mmToM(parseNumber(document.getElementById("perimLibreLongueur").value));
        surf1FaceParPiece_m2 = perim * L;
        surfParPiece_m2 = surf1FaceParPiece_m2 * nbFaces;
        longueurParPiece_m = L;
        details = `Profil spécial – périm=${perim.toFixed(3)} m, L=${L.toFixed(3)} m.`;
      }

      if (geoType === "limon") {
        const L_m = mmToM(parseNumber(document.getElementById("limonLongueur").value));
        const profilType = limonProfilType.value;
        let surfProfil1Face_m2 = 0;

        if (profilType === "tubeRect") {
          const larg = mmToM(parseNumber(document.getElementById("limonTubeRectLargeur").value));
          const haut = mmToM(parseNumber(document.getElementById("limonTubeRectHauteur").value));
          const perim = 2 * (larg + haut);
          surfProfil1Face_m2 = (perim / 2) * L_m;
          details = `Limon tube rect ${larg.toFixed(3)}×${haut.toFixed(3)} m, L=${L_m.toFixed(3)} m.`;
        } else if (profilType === "tubeRond") {
          const d = mmToM(parseNumber(document.getElementById("limonTubeRondDiametre").value));
          surfProfil1Face_m2 = (Math.PI * d * L_m) / 2;
          details = `Limon tube rond D=${d.toFixed(3)} m, L=${L_m.toFixed(3)} m.`;
        } else if (profilType === "plat") {
          const larg = mmToM(parseNumber(document.getElementById("limonPlatLargeur").value));
          surfProfil1Face_m2 = larg * L_m;
          details = `Limon plat larg=${larg.toFixed(3)} m, L=${L_m.toFixed(3)} m.`;
        } else if (profilType === "profilU") {
          const sem = mmToM(parseNumber(document.getElementById("limonUSemelle").value));
          const h = mmToM(parseNumber(document.getElementById("limonUHauteur").value));
          const dev1Face = sem + 2 * h;
          surfProfil1Face_m2 = dev1Face * L_m;
          details = `Limon U sem=${sem.toFixed(3)} m, h=${h.toFixed(3)} m, L=${L_m.toFixed(3)} m.`;
        } else if (profilType === "perimetreLibre") {
          const perim = mmToM(parseNumber(document.getElementById("limonPerimLibre").value));
          surfProfil1Face_m2 = perim * L_m;
          details = `Limon profil spécial périm=${perim.toFixed(3)} m, L=${L_m.toFixed(3)} m.`;
        }

        const supportLargeur_m = mmToM(parseNumber(document.getElementById("supportLargeur").value));
        const supportHauteur_m = mmToM(parseNumber(document.getElementById("supportHauteur").value));
        const supportLongueur_m = mmToM(parseNumber(document.getElementById("supportLongueur").value));
        const supportNb = parseNumber(document.getElementById("supportNb").value) || 0;

        let surfSupports1FaceTot_m2 = 0;
        if (supportNb > 0 && supportLargeur_m > 0 && (supportHauteur_m > 0 || supportLongueur_m > 0)) {
          const surf1FaceSupport = supportLargeur_m * supportHauteur_m
            + supportLargeur_m * supportLongueur_m;
          surfSupports1FaceTot_m2 = surf1FaceSupport * supportNb;
          details += `<br>Supports : larg=${supportLargeur_m.toFixed(3)} m, h=${supportHauteur_m.toFixed(3)} m, L=${supportLongueur_m.toFixed(3)} m × ${supportNb} pcs.`;
        }

        surf1FaceParPiece_m2 = surfProfil1Face_m2 + surfSupports1FaceTot_m2;
        surfParPiece_m2 = surf1FaceParPiece_m2 * nbFaces;
        longueurParPiece_m = L_m;
        details += `<br>Surface 1 face (profil + supports) : ${surf1FaceParPiece_m2.toFixed(3)} m²`;
      }

      if (!surfParPiece_m2 || surfParPiece_m2 <= 0 || qte <= 0) {
        resultPiece.innerHTML = "⚠️ Vérifie les dimensions, les faces et la quantité.";
        return null;
      }

      const totalSurf_m2 = surfParPiece_m2 * qte;
      const totalLong_m = longueurParPiece_m * qte;

      const poudreM2 = parseNumber(document.getElementById("poudreM2").value);
      const poudreTotal = poudreM2 > 0 ? totalSurf_m2 * poudreM2 : 0;

      const tarifM2 = getTarifM2(tarifKey);
      const tarifML = getTarifML(tarifKey);
      let prix = 0;
      if (modeFacturation === "m2") {
        prix = tarifM2 > 0 ? totalSurf_m2 * tarifM2 : 0;
      } else {
        prix = tarifML > 0 ? totalLong_m * tarifML : 0;
      }

      const refLine = ref ? `Pièce : <strong>${ref}</strong><br>` : "";

      resultPiece.innerHTML = `
        ${refLine}
        Type : <em>${tarifLabel}</em><br>
        Géométrie : <em>${geoType}</em><br>
        Faces : <strong>${nbFaces}</strong> – Mode : <strong>${modeFacturation}</strong><br><br>
        ${details}<br><br>
        Surface / pièce : <strong>${surfParPiece_m2.toFixed(3)} m²</strong><br>
        Longueur / pièce : <strong>${longueurParPiece_m.toFixed(3)} m</strong><br>
        Quantité : <strong>${qte}</strong><br>
        Surface totale : <strong>${totalSurf_m2.toFixed(3)} m²</strong><br>
        Longueur totale : <strong>${totalLong_m.toFixed(3)} m</strong><br>
        Prix estimatif : <strong>${prix.toFixed(2)} €</strong><br>
        Poudre estimée : <strong>${poudreTotal.toFixed(2)} kg</strong>
      `;

      return {
        ref: ref || "(sans nom)",
        typeLabel: tarifLabel,
        geoType,
        modeFacturation,
        qte,
        nbFaces,
        surfParPiece_m2,
        longueurParPiece_m,
        totalSurf_m2,
        totalLong_m,
        prix,
        poudreTotal,
      };
    }

    document.getElementById("btnCalcPiece").addEventListener("click", calcPiece);

    // RECAP
    const tableBody = document.querySelector("#tableDevis tbody");
    const totauxDiv = document.getElementById("totauxDevis");
    let devisItems = [];

    function refreshDevis() {
      tableBody.innerHTML = "";
      let totSurf = 0, totLong = 0, totPrix = 0, totPoudre = 0;

      devisItems.forEach((it, i) => {
        totSurf += it.totalSurf_m2;
        totLong += it.totalLong_m;
        totPrix += it.prix;
        totPoudre += it.poudreTotal;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>${it.ref}</td>
          <td>${it.typeLabel}</td>
          <td class="text-right">${it.qte}</td>
          <td class="text-right">${it.nbFaces}</td>
          <td class="text-right">${it.surfParPiece_m2.toFixed(3)}</td>
          <td class="text-right">${it.longueurParPiece_m.toFixed(3)}</td>
          <td class="text-right">${it.totalSurf_m2.toFixed(3)}</td>
          <td class="text-right">${it.totalLong_m.toFixed(3)}</td>
          <td class="text-right">${it.prix.toFixed(2)}</td>
          <td class="text-right">${it.poudreTotal.toFixed(2)}</td>
        `;
        tableBody.appendChild(tr);
      });

      if (!devisItems.length) {
        totauxDiv.textContent = "Aucun élément pour l’instant.";
      } else {
        let txt = `Total surface : <strong>${totSurf.toFixed(3)} m²</strong> – Longueur : <strong>${totLong.toFixed(3)} m</strong>`;
        txt += ` – Prix total estimatif : <strong>${totPrix.toFixed(2)} €</strong>`;
        if (totPoudre > 0) txt += ` – Poudre totale : <strong>${totPoudre.toFixed(2)} kg</strong>`;
        totauxDiv.innerHTML = txt;
      }
    }

    document.getElementById("btnAddDevis").addEventListener("click", () => {
      const item = calcPiece();
      if (!item) return;
      devisItems.push(item);
      refreshDevis();
    });

    document.getElementById("btnResetDevis").addEventListener("click", () => {
      devisItems = [];
      refreshDevis();
    });
  </script>
</body>
</html>
